<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moving &amp; Handling ‚Äì Delegate Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
</head>
<body style="background:#f0f4f8; font-family: Arial, sans-serif;">
  <div class="visit-card">
    <div class="header">üßç Moving &amp; Handling ‚Äì Delegate Assessment</div>

    <form id="mh-form">
      <input type="hidden" name="form_type" value="moving_handling">
      <input type="hidden" name="form_version" value="2025-08-18">

      <!-- Session details (prefilled from start menu if used) -->
      <fieldset>
        <legend>Session Details</legend>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: .75rem;">
          <label>Assessor
            <input id="assessor_name" name="assessor_name" type="text" placeholder="Assessor name">
          </label>
          <label>Date
            <input id="training_date" name="training_date" type="date">
          </label>
          <label>Venue
            <input id="venue" name="venue" type="text" placeholder="Training venue / hub">
          </label>
        </div>
      </fieldset>

      <!-- Learner details -->
      <fieldset>
        <legend>Learner Details</legend>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: .75rem;">
          <label>Name
            <input name="learner_name" type="text" required>
          </label>
          <label>Date
            <input name="learner_date" type="date" required>
          </label>
          <label>Hub
            <input name="hub" type="text" required>
          </label>
        </div>
      </fieldset>

      <!-- Self-assessment table -->
      <fieldset>
        <legend>Moving &amp; Handling Delegate Self-Assessment</legend>
        <p>Please fill in the table below regarding Moving and Handling techniques.</p>
        <table>
          <thead>
            <tr>
              <th style="width:55%;">Technique</th>
              <th style="width:15%;">Practiced<br>(Yes/No)</th>
              <th style="width:30%;">Confident using technique<br>(Yes/No)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Assisting a client to the edge of a chair</td>
              <td>
                <select name="tech_edge_chair_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_edge_chair_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Sit to stand ‚Äì with assistance of one and two carers</td>
              <td>
                <select name="tech_sit_to_stand_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_sit_to_stand_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Assisted walk</td>
              <td>
                <select name="tech_assisted_walk_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_assisted_walk_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Using the Transfer Board (Banana board)</td>
              <td>
                <select name="tech_transfer_board_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_transfer_board_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Using the Handling Belt</td>
              <td>
                <select name="tech_handling_belt_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_handling_belt_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Using the Rota-Stand</td>
              <td>
                <select name="tech_rotastand_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_rotastand_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Fitting a sling in the chair</td>
              <td>
                <select name="tech_sling_chair_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_sling_chair_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Hoisting with Manual Hoist</td>
              <td>
                <select name="tech_manual_hoist_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_manual_hoist_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Fitting a slide sheet in bed using barrel roll ‚Äì Two carers</td>
              <td>
                <select name="tech_slide_sheet_fit_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_slide_sheet_fit_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Repositioning in bed using a slide sheet ‚Äì Two carers</td>
              <td>
                <select name="tech_slide_sheet_reposition_practiced" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_slide_sheet_reposition_confident" required>
                  <option value=""></option><option>Yes</option><option>No</option>
                </select>
              </td>
            </tr>
          </tbody>
        </table>
      </fieldset>

      <!-- Trainer Comments -->
      <fieldset>
        <legend>Trainer Comments</legend>
        <textarea name="trainer_comments" rows="6"></textarea>
      </fieldset>

      <!-- Outcome -->
      <fieldset>
        <legend>Outcome</legend>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: .75rem; align-items:center;">
          <label><input type="radio" name="outcome" value="Pass" required> Pass</label>
          <label><input type="radio" name="outcome" value="Refer for further support" required> Refer for further support</label>
        </div>

        <div style="display:grid; grid-template-columns: 2fr 1fr; gap: .75rem; margin-top: .75rem;">
          <label>Trainer Name
            <input name="trainer_name" type="text">
          </label>

          <div class="sig-field">
            <label><strong>Trainer Signature</strong></label>
            <canvas id="trainerSig" width="800" height="160"
              style="width:100%;height:140px;background:#fff;touch-action:none;display:block;border:1px solid #e5e7eb;border-radius:6px"></canvas>
            <button type="button" id="trainerSigClear">Clear</button>
          </div>
        </div>

        <!-- Hidden fields populated on submit -->
        <input type="hidden" name="trainer_signature_dataurl" id="trainer_signature_dataurl">
        <input type="hidden" name="trainer_signature_filename" id="trainer_signature_filename">
      </fieldset>

      <div class="buttons" style="display:flex; gap:.5rem;">
        <button type="button" onclick="location.href='home.html'">Back</button>
        <button type="submit">Submit</button>
      </div>
    </form>
  </div>

  <script>
    // Prefill from localStorage
    (function () {
      const a = localStorage.getItem('assessor_name') || '';
      const d = localStorage.getItem('training_date') || '';
      const v = localStorage.getItem('venue') || '';
      const A = document.getElementById('assessor_name');
      const D = document.getElementById('training_date');
      const V = document.getElementById('venue');
      if (A && a) A.value = a;
      if (D && d) D.value = d;
      if (V && v) V.value = v;
    })();

    // Signature pad (pointer events; high-DPI safe)
    function setupSigPad(canvasId, clearBtnId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return null;
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      let drawing = false, hasInk = false;

      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = canvas.getBoundingClientRect();
        const w = Math.max(1, Math.round(rect.width * ratio));
        const h = Math.max(1, Math.round(rect.height * ratio));
        if (canvas.width !== w || canvas.height !== h) {
          canvas.width = w; canvas.height = h;
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
          ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.strokeStyle = '#111827';
        }
      }
      resizeCanvas();
      if (window.ResizeObserver) new ResizeObserver(resizeCanvas).observe(canvas);
      window.addEventListener('resize', resizeCanvas);

      const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        const x = (e.clientX ?? e.touches?.[0]?.clientX) - r.left;
        const y = (e.clientY ?? e.touches?.[0]?.clientY) - r.top;
        return { x, y };
      };

      const down = (e) => { e.preventDefault(); drawing = true; hasInk = true; const {x,y}=getPos(e); ctx.beginPath(); ctx.moveTo(x,y); };
      const move = (e) => { if (!drawing) return; e.preventDefault(); const {x,y}=getPos(e); ctx.lineTo(x,y); ctx.stroke(); };
      const up   = (e) => { if (!drawing) return; e.preventDefault(); drawing = false; };

      if ('PointerEvent' in window) {
        canvas.addEventListener('pointerdown', down, { passive:false });
        canvas.addEventListener('pointermove', move, { passive:false });
        canvas.addEventListener('pointerup', up);
        canvas.addEventListener('pointerleave', up);
        canvas.addEventListener('pointercancel', up);
      } else {
        canvas.addEventListener('mousedown', down);
        canvas.addEventListener('mousemove', move);
        window.addEventListener('mouseup', up);
        canvas.addEventListener('touchstart', down, { passive:false });
        canvas.addEventListener('touchmove', move, { passive:false });
        canvas.addEventListener('touchend', up);
      }

      const clearBtn = document.getElementById(clearBtnId);
      clearBtn?.addEventListener('click', () => { ctx.clearRect(0,0,canvas.width,canvas.height); hasInk = false; });

      return {
        toDataURL: () => (hasInk ? canvas.toDataURL('image/png') : ''),
        hasInk: () => hasInk,
        clear: () => { ctx.clearRect(0,0,canvas.width,canvas.height); hasInk = false; }
      };
    }

    // Init trainer signature pad
    const trainerSigPad = setupSigPad('trainerSig', 'trainerSigClear');

    // Helpers for safe filenames
    function slug(s) {
      return String(s || '')
        .normalize('NFKD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^A-Za-z0-9_-]+/g, '-')
        .replace(/-+/g, '-').replace(/^-+|-+$/g, '')
        .slice(0, 60);
    }
    function safeDate(s) {
      const d = new Date(s);
      if (!isNaN(d)) return d.toISOString().slice(0,10);
      return String(s || '').replace(/[^0-9]/g, '').replace(/^(\d{4})(\d{2})(\d{2}).*$/, '$1-$2-$3');
    }

    // Submit ‚Üí n8n (Moving & Handling)
    document.getElementById('mh-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Submitting‚Ä¶'; }

      // Push trainer signature data + filename into hidden inputs
      const trainerName = form.querySelector('[name="trainer_name"]')?.value || '';
      const dateVal = form.querySelector('[name="learner_date"]')?.value ||
                      form.querySelector('[name="training_date"]')?.value || '';

      const trainerDataURL = trainerSigPad ? trainerSigPad.toDataURL() : '';
      document.getElementById('trainer_signature_dataurl').value = trainerDataURL;
      document.getElementById('trainer_signature_filename').value =
        `trainer_signature_${slug(trainerName)}_${safeDate(dateVal)}.png`;

      // Build payload
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());

      try {
        const res = await fetch('https://routeshealthcare.app.n8n.cloud/webhook/moving-handling-submit', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        alert(res.ok ? 'Submitted ‚Äì thank you!' : 'There was an issue submitting your form.');
      } catch (err) {
        alert('Network error submitting form.');
      } finally {
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit'; }
      }
    });
  </script>
</body>
</html>
