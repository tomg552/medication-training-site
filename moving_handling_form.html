<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moving &amp; Handling ‚Äì Delegate Self-Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
</head>
<body style="background:#f0f4f8; font-family: Arial, sans-serif;">
  <div class="visit-card">
    <div class="header">üßç Moving &amp; Handling ‚Äì Delegate Self-Assessment</div>

    <form id="mh-form">
      <input type="hidden" name="form_type" value="moving_handling">
      <input type="hidden" name="form_version" value="2025-08-18">

      <!-- Session details (prefilled from start menu if used) -->
      <fieldset>
        <legend>Session Details</legend>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: .75rem;">
          <label>Assessor
            <input id="assessor_name" name="assessor_name" type="text" placeholder="Assessor name">
          </label>
          <label>Date
            <input id="training_date" name="training_date" type="date">
          </label>
          <label>Venue
            <input id="venue" name="venue" type="text" placeholder="Training venue / hub">
          </label>
        </div>
      </fieldset>

      <!-- Candidate details -->
      <fieldset>
        <legend>Learner Details</legend>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: .75rem;">
          <label>Name
            <input name="learner_name" type="text" required>
          </label>
          <label>Date
            <input name="learner_date" type="date" required>
          </label>
          <label>Hub
            <input name="hub" type="text" required>
          </label>
        </div>
      </fieldset>

      <!-- Self-assessment table -->
      <fieldset>
        <legend>Moving &amp; Handling Delegate Self-Assessment</legend>
        <p>Please fill in the table below regarding Moving and Handling techniques.</p>
        <table>
          <thead>
            <tr>
              <th style="width:55%;">Technique</th>
              <th style="width:15%;">Practiced<br>(Yes/No)</th>
              <th style="width:30%;">Confident using technique<br>(Yes/No)</th>
            </tr>
          </thead>
          <tbody>
            <!-- Each row mirrors the Word document items -->
            <tr>
              <td>Assisting a client to the edge of a chair</td>
              <td>
                <select name="tech_edge_chair_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_edge_chair_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Sit to stand ‚Äì with assistance of one and two carers</td>
              <td>
                <select name="tech_sit_to_stand_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_sit_to_stand_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Assisted walk</td>
              <td>
                <select name="tech_assisted_walk_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_assisted_walk_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Using the Transfer Board (Banana board)</td>
              <td>
                <select name="tech_transfer_board_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_transfer_board_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Using the Handling Belt</td>
              <td>
                <select name="tech_handling_belt_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_handling_belt_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Using the Rota-Stand</td>
              <td>
                <select name="tech_rotastand_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_rotastand_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Fitting a sling in the chair</td>
              <td>
                <select name="tech_sling_chair_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_sling_chair_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Hoisting with Manual Hoist</td>
              <td>
                <select name="tech_manual_hoist_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_manual_hoist_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Fitting a slide sheet in bed using barrel roll ‚Äì Two carers</td>
              <td>
                <select name="tech_slide_sheet_fit_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_slide_sheet_fit_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Repositioning in bed using a slide sheet ‚Äì Two carers</td>
              <td>
                <select name="tech_slide_sheet_reposition_practiced" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
              <td>
                <select name="tech_slide_sheet_reposition_confident" required>
                  <option value=""></option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>
            </tr>
          </tbody>
        </table>
      </fieldset>

      <!-- Comments -->

      <fieldset>
        <legend>Trainer Comments</legend>
        <textarea name="trainer_comments" rows="6"></textarea>
      </fieldset>

      <!-- Outcome -->
      <fieldset>
        <legend>Outcome</legend>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: .75rem; align-items:center;">
          <label>
            <input type="radio" name="outcome" value="Pass" required> Pass
          </label>
          <label>
            <input type="radio" name="outcome" value="Refer for further support" required> Refer for further support
          </label>
        </div>
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap: .75rem; margin-top: .75rem;">
          <label>Trainer Name
            <input name="trainer_name" type="text">
          </label>
          <div class="sig-field">
          <label for="trainerSig"><strong>Trainer Signature</strong></label>
          <div class="sig-wrap" style="border:1px solid #e5e7eb; border-radius:6px; padding:.5rem;">
          <canvas id="trainerSig" class="sig-canvas" aria-label="Trainer signature area" style="width:100%; height:140px; touch-action: none;"></canvas>
          <div class="sig-actions" style="margin-top:.5rem; display:flex; gap:.5rem;">
          <button type="button" id="trainerSigClear">Clear</button>
    </div>
  </div>
  <input type="hidden" name="trainer_signature_dataurl" id="trainer_signature_dataurl">
  <input type="hidden" name="trainer_signature_filename" id="trainer_signature_filename">
</div>

        </div>
      </fieldset>

      <div class="buttons">
        <button type="submit">Submit</button>
      </div>
    </form>
  </div>

<script>
  // Prefill from localStorage
  (function () {
    const a = localStorage.getItem('assessor_name') || '';
    const d = localStorage.getItem('training_date') || '';
    const v = localStorage.getItem('venue') || '';
    if (a) document.getElementById('assessor_name').value = a;
    if (d) document.getElementById('training_date').value = d;
    if (v) document.getElementById('venue').value = v;
  })();

  // --- Signature helper ---
  function setupSignature(canvasId, clearBtnId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let hasInk = false;

    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      ctx.scale(ratio, ratio);
      ctx.lineWidth = 2;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111827';
    }

    function pos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function start(e) {
      e.preventDefault();
      drawing = true;
      hasInk = true;
      const { x, y } = pos(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function move(e) {
      if (!drawing) return;
      e.preventDefault();
      const { x, y } = pos(e);
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function end(e) {
      if (!drawing) return;
      e.preventDefault();
      drawing = false;
    }

    // Events (mouse + touch + pointer-friendly)
    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start, { passive: false });
    canvas.addEventListener('touchmove', move, { passive: false });
    canvas.addEventListener('touchend', end);

    // Clear
    const clr = document.getElementById(clearBtnId);
    if (clr) clr.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasInk = false;
    });

    // Init + on resize
    const ro = new ResizeObserver(resizeCanvas);
    ro.observe(canvas);
    resizeCanvas();

    return {
      canvas,
      toDataURL: () => (hasInk ? canvas.toDataURL('image/png') : ''),
      hasInk: () => hasInk,
      clear: () => { ctx.clearRect(0, 0, canvas.width, canvas.height); hasInk = false; }
    };
  }

  // Initialise both signature pads
  const learnerSig = setupSignature('learnerSig', 'learnerSigClear');
  const trainerSig = setupSignature('trainerSig', 'trainerSigClear');

  // Helpers for safe filenames
  function slug(s) {
    return String(s || '')
      .normalize('NFKD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^A-Za-z0-9_-]+/g, '-')
      .replace(/-+/g, '-').replace(/^-+|-+$/g, '')
      .slice(0, 60);
  }
  function safeDate(s) {
    const d = new Date(s);
    if (!isNaN(d)) return d.toISOString().slice(0,10);
    return String(s || '').replace(/[^0-9]/g, '').replace(/^(\d{4})(\d{2})(\d{2}).*$/, '$1-$2-$3');
  }

  // Submit ‚Üí n8n (Moving & Handling)
  document.getElementById('mh-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Submitting‚Ä¶'; }

    // Push signature data + filenames into hidden inputs
    const learnerName = form.querySelector('[name="learner_name"]')?.value || '';
    const trainerName = form.querySelector('[name="trainer_name"]')?.value || '';
    const dateVal = form.querySelector('[name="learner_date"]')?.value ||
                    form.querySelector('[name="training_date"]')?.value || '';

    const learnerDataURL = learnerSig.toDataURL();
    const trainerDataURL = trainerSig.toDataURL();

    document.getElementById('learner_signature_dataurl').value = learnerDataURL;
    document.getElementById('trainer_signature_dataurl').value = trainerDataURL;

    document.getElementById('learner_signature_filename').value =
      `learner_signature_${slug(learnerName)}_${safeDate(dateVal)}.png`;
    document.getElementById('trainer_signature_filename').value =
      `trainer_signature_${slug(trainerName)}_${safeDate(dateVal)}.png`;

    // Build payload
    const fd = new FormData(form);
    if (!fd.has('form_type')) fd.append('form_type', 'moving_handling');
    if (!fd.has('form_version')) fd.append('form_version', '2025-08-18');

    const payload = Object.fromEntries(fd.entries());

    try {
      const res = await fetch('https://routeshealthcare.app.n8n.cloud/webhook-test/moving-handling-submit', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      alert(res.ok ? 'Submitted ‚Äì thank you!' : 'There was an issue submitting your form.');
    } catch (err) {
      alert('Network error submitting form.');
    } finally {
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit'; }
    }
  });
</script>


</body>
</html>
