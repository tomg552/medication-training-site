<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Due Care: Medical & Learning Needs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="visit-card">
    <form id="dueCareForm"
          action="https://routeshealthcare.app.n8n.cloud/webhook-test/bls-competency-submit"
          method="post"
          enctype="multipart/form-data">
      <!-- ===== Session & Participant Details (TOP) ===== -->
      <fieldset>
        <legend>Session & Participant Details</legend>

        <label for="learner_name">Learner Name</label>
        <input type="text" id="learner_name" name="learner_name" />

        <label for="trainer_name_top">Trainer Name</label>
        <input type="text" id="trainer_name_top" name="trainer_name" />

        <label for="course">Course</label>
        <input type="text" id="course" name="course" />

        <label for="venue">Venue</label>
        <input type="text" id="venue" name="venue" />

        <label for="date_top">Date</label>
        <input type="date" id="date_top" name="date" />
      </fieldset>

      <!-- ===== Main Form Content ===== -->
      <fieldset>
        <legend>Medical Information & Additional Learning Requirements</legend>

        <p>
          The trainer MUST be made aware of any medical conditions which may affect your ability
          to carry out the practical tasks on this course.
        </p>

        <label for="health_issues">
          Please list any health or physical problems that could affect safe participation
          (e.g. respiratory conditions; old/current injuries of concern; any disability affecting
          safe completion; pregnancy or postnatal stages; allergies; or any other relevant issue).
        </label>
        <textarea id="health_issues" name="health_issues"></textarea>

        <label for="learning_requirements">
          Do you have any additional learning requirements? If yes, list them here (including any
          additional resources or adjustments you may require).
        </label>
        <textarea id="learning_requirements" name="learning_requirements"></textarea>

        <p>
          If you wish to discuss any matters in private, please make the trainer aware.
          Please report any injuries to the trainer immediately.
        </p>
      </fieldset>

      <fieldset>
        <legend>Trainer Comments</legend>
        <textarea id="trainer_comments" name="trainer_comments"></textarea>
      </fieldset>

      <!-- ===== Signatures (BOTTOM) ===== -->
      <fieldset>
        <legend>Signature</legend>

        <!-- Trainer Signature -->
        <label>Trainer Signature</label>
        <div style="border:1px solid #ccc; border-radius:6px; padding:0.5rem;">
          <canvas id="sig_trainer" width="600" height="140" style="width:100%; height:140px;"></canvas>
          <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
            <button type="button" id="clear_trainer">Clear</button>
          </div>
        </div>

        <!-- Data URL (PNG) captured from canvas -->
        <input type="hidden" name="trainer_signature_png" id="trainer_signature_png" />
        <!-- Extra fields for n8n Convert to File -->
        <input type="hidden" name="fileName" id="signature_file_name" />
        <input type="hidden" name="base64" id="trainer_signature_base64" />

        <!-- Repeated names/dates near signatures -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem;">
          <div>
            <label for="learner_name_confirm">Learner Name (confirm)</label>
            <input type="text" id="learner_name_confirm" name="learner_name_confirm" />
          </div>
          <div>
            <label for="trainer_name_confirm">Trainer Name (confirm)</label>
            <input type="text" id="trainer_name_confirm" name="trainer_name_confirm" />
          </div>
          <div>
            <label for="date_bottom">Date (confirm)</label>
            <input type="date" id="date_bottom" name="date_confirm" />
          </div>
        </div>
      </fieldset>

      <!-- Optional: form metadata helpful in your n8n mapper -->
      <input type="hidden" name="form_type" value="due_care_medical_learning_needs" />
      <input type="hidden" name="form_version" value="v1" />

      <div class="buttons">
        <button type="submit">Submit</button>
      </div>
    </form>
  </div>

  <script>
    // ---- Prefill from localStorage (consistent with other pages) ----
    document.addEventListener("DOMContentLoaded", () => {
      const get = (k) => localStorage.getItem(k) || "";

      const assessee = get("assessee_name");  // learner
      const assessor = get("assessor_name");  // trainer
      const venueVal = get("venue");
      const sessionDate = get("session_date"); // ISO yyyy-mm-dd preferred

      const setVal = (id, val) => { const el = document.getElementById(id); if (el && !el.value) el.value = val; };

      setVal("learner_name", assessee);
      setVal("trainer_name_top", assessor);
      setVal("course", get("course"));
      setVal("venue", venueVal);
      setVal("date_top", sessionDate);

      // Mirror to bottom confirmations
      setVal("learner_name_confirm", assessee);
      setVal("trainer_name_confirm", assessor);
      setVal("date_bottom", sessionDate);
    });

    // ---- Lightweight signature pad (no external libs) ----
    function makeSigPad(canvasId, clearBtnId, hiddenFieldId) {
      const canvas = document.getElementById(canvasId);
      const clearBtn = document.getElementById(clearBtnId);
      const hidden = document.getElementById(hiddenFieldId);
      const ctx = canvas.getContext("2d");

      let drawing = false;
      let last = null;

      const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : null;
        const clientX = touch ? touch.clientX : e.clientX;
        const clientY = touch ? touch.clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      };

      const start = (e) => { drawing = true; last = getPos(e); e.preventDefault(); };
      const move = (e) => {
        if (!drawing) return;
        const p = getPos(e);
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        last = p;
        e.preventDefault();
      };
      const end = () => {
        drawing = false;
        hidden.value = canvas.toDataURL("image/png");
      };

      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", move);
      canvas.addEventListener("mouseup", end);
      canvas.addEventListener("mouseleave", end);

      canvas.addEventListener("touchstart", start, { passive: false });
      canvas.addEventListener("touchmove", move, { passive: false });
      canvas.addEventListener("touchend", end);

      clearBtn.addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        hidden.value = "";
      });
    }

    // Only the trainer signature is present in this markup—so we init just that one.
    document.addEventListener("DOMContentLoaded", () => {
      makeSigPad("sig_trainer", "clear_trainer", "trainer_signature_png");
    });

    // ---- Before submit: derive fields for n8n ConvertToFile ----
    document.getElementById("dueCareForm").addEventListener("submit", (e) => {
      // Ensure trainer PNG data URL exists if anything was drawn.
      const dataUrl = document.getElementById("trainer_signature_png").value || "";
      // Strip "data:image/png;base64," → ConvertToFile often expects raw base64
      const base64Only = dataUrl.replace(/^data:image\/png;base64,/, "");
      document.getElementById("trainer_signature_base64").value = base64Only;

      // Give SharePoint / n8n a sensible filename
      const fileName = `signature-${Date.now()}.png`;
      document.getElementById("signature_file_name").value = fileName;

      // If you want to require a signature, uncomment:
      // if (!base64Only) { e.preventDefault(); alert("Please add the trainer's signature."); }
    });
  </script>
</body>
</html>
